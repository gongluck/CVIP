# IP

- [IP](#ip)
  - [IP 特性](#ip-特性)
  - [分片（Fragmentation）](#分片fragmentation)
  - [IP Package](#ip-package)
  - [IPv4 寻址](#ipv4-寻址)
  - [路由（Routing）](#路由routing)
  - [IPv6](#ipv6)
    - [IPv6 特点](#ipv6-特点)
    - [IPv6 寻址](#ipv6-寻址)
  - [NAT 网络地址转换技术](#nat-网络地址转换技术)
  - [ARP 地址解析协议](#arp-地址解析协议)

## IP 特性

- IP 协议（Internet Protocol）是一个处于垄断地位的网络层协议。为传输层提供 Host-To-Host 的能力，需要底层数据链路层的支持。
- IP 协议并不负责数据的可靠性。传输数据时，数据被切分成一个个数据封包。IP 协议上层的传输层协议会对数据进行一次拆分，IP 协议还会进一步进行拆分。进行两次拆分是为了适配底层的设备。

## 分片（Fragmentation）

- IP 协议接收 IP 协议上方的 Host-To-Host 协议传来的数据，然后进行拆分，这个能力叫作分片（Fragmentation）。然后 IP 协议为每个片段（Fragment）增加一个 IP 头（Header），组成一个 IP 封包（Datagram）。之后，IP 协议调用底层的局域网（数据链路层）传送数据。最后 IP 协议通过寻址和路由能力最终把封包送达目的地。
- IP 协议通过它下层的局域网（链路层）协议传输数据，因此需要适配底层传输网络的传输能力。数据太大通常就不适合底层网络传输，这就需要把大的数据切片。
- 当然也可能选择不切片，IP 协议提供了一个能力就是把封包标记为不切片，当底层网络看到不切片的封包，又没有能力传输的时候，就会丢弃这个封包。
- 在网络环境中往往存在多条路径，一条路径断了，说不定其他路径可以连通。

## IP Package

![IP包](https://github.com/gongluck/images/blob/main/network/ip/ip_package.png)

- IPv4 的地址是 4 组 8 位的数字，总共是 32 位。
- **Type Of Service 服务的类型**，是为了响应不同的用户诉求，用来选择延迟、吞吐量和丢包率之间的关系。
- IHL（Internet Header Length）用来描述 IP 协议头的大小。所以 IP 协议头的大小是可变的。IHL 只有 4 位，最大值 1111 = 15。最大是 15 个双字（15\*4 字节 = 60 字节）。
- Total Length 定义报文（封包 Datagram）的长度。
- Identification（报文的 ID），发送方分配，代表顺序。
- **Fragment offset 描述要不要分包（拆分），以及如何拆分。**
- **Time To Live 描述封包存活的时间**。因此每个 IP 封包发送出去后，就开始销毁倒计时。如果倒计时为 0，就会销毁。比如中间的路由器看到一个 TTL 为 0 的封包，就直接丢弃。
- **Protocol 是描述上层的协议**，比如 TCP = 6，UDP = 17。
- Options 代表可选项。
- Checksum 用来检验封包的正确性，如果 Checksum 对不上，就需要选择丢弃这个封包。

## IPv4 寻址

- IPv4 地址是 4 个 8 位（Octet）排列而成，总共可以编址 43 亿个地址。
- IP 协议的寻址过程需要逐级找到网络，最后定位设备。
  - 步骤 1：找到顶层网络
    - 比如 103.16.3.1 最顶层的网络号可以和 255.0.0.0（子网掩码）做位与运算得到 103.16.3.1 & 255.0.0.0 = 103.0.0.0。
    - 因此 103.0.0.0 就是 103.16.3.1 所在的顶层网络。
  - 步骤 2：找到下一层网络
    - 接下来要找到下一级网络，就需要用 IP 地址和下一级的子网掩码做位与运算。
    - 103.16.3.1 & 255.255.0.0 = 103.16.0.0
    - 其中 103.16.0.0 就是下一级的网络号。
  - 步骤 3：找到再下一级网络
    - 接下来使用 255.255.255.0 子网掩码找到下一级网络是 103.16.3.0。
  - 步骤 4：定位设备
    - 设备就在子网 103.16.3.0 中，最终找到的设备号是 1。

## 路由（Routing）

- 在寻址过程中，数据总是存于某个局域网中。如果目的地在局域网中，就可以直接定位到设备了。如果目的地不在局域网中，这个时候，就需再去往其他网络。
- 由于网络和网络间是网关在连接，因此如果目的地 IP 不在局域网中，就需要为 IP 封包选择通往下一个网络的路径，其实就是选择其中一个网关。
- 路由（Routing）本质是路径的选择。

## IPv6

### IPv6 特点

- IPv4 的地址是 4 个 8 位（octet），总共 32 位。
- IPv6 的地址是 8 个 16 位（hextet），总共 128 位。
- IPv6 解决的是地址耗尽的问题。因为解决了地址耗尽的问题，所以很多其他问题也得到了解决，比如说减少了子网，更小的封包头部体积，最终提升了性能等。

### IPv6 寻址

- IPv6 地址很充裕，因此对网络的划分和 IPv4 有很显著的差异。
- IPv6 的寻址分成了几种类型：
  - 全局单播寻址（和 IPv4 地址作用差不多，在互联网中通过地址查找一个设备，简单来说，单播就是 1 对 1）；
  - 本地单播（类似 IPv4 里的一个内部网络，要求地址必须以 fe80 开头，类似我们 IPv4 中 127 开头的地址）；
  - 分组多播（Group Multicast），类似今天我们说的广播，将消息发送给多个接收者；
  - 任意播（Anycast），这个方式比较特殊。
- 全局单播
  - **IPv6 地址太多，因此不再需要子网掩码，而是直接将 IPv6 的地址分区即可。**
  - 在实现全局单播时，IPv6 地址通常分成 3 个部分：
    - 站点前缀（Site Prefix）48bit，一般是由 ISP（Internet Service Providor，运营商）或者 RIR（Regional Internet Registry， 地区性互联网注册机构），RIR 将 IP 地址分配给运营商；
    - 子网号（Subnet ID），16bit，用于站点内部区分子网；
    - 接口号（Interface ID）， 64bit，用于站点内部区分设备。
- 本地单播
  - 理论上，虽然 IPv6 可以将所有的设备都连入一个网络。但在实际场景中，很多公司还是需要一个内部网络的。这种情况在 IPv6 的设计中属于局域网络。
  - 本地单播地址必须以 fe80 开头，后面 64 位的 0，然后接上 54 位的设备编号。
- 分组多播
  - 有时候，需要实现广播。所谓广播，就是将消息同时发送给多个接收者。
  - IPv6 中设计了分组多播，来实现广播的能力。当 IP 地址以 8 个 1 开头，也就是 ff00 开头，后面会跟上一个分组的编号时，就是在进行分组多播。
  - 这个时候，需要一个广播设备，在这个设备中已经定义了这些分组编号，并且拥有分组下所有设备的清单，这个广播设备会帮助我们将消息发送给对应分组下的所有设备。
- 任意播（Anycast）
  - 任意播，本质是将消息发送给多个接收方，并选择一条最优的路径。
  - 比如说在一个网络中有多个授时服务，这些授时服务都共享了一个任播地址。当一个客户端想要获取时间，就可以将请求发送到这个任播地址。客户端的请求扩散出去后，可能会找到授时服务中的一个或者多个，但是距离最近的往往会先被发现。这个时候，客户端就使用它第一次收到的授时信息修正自己的时间。

## NAT 网络地址转换技术

- 在一个局域网中，我们不可以将消息从一个接口（网卡）发送到另一个接口（网卡），而是要通过交换机。
- 数据的发送方，将自己的 MAC 地址、目的地 MAC 地址，以及数据作为一个链路层分组（Packet），也称作 Frame 或者封包，发送给交换机。交换机再根据目的地 MAC 地址，将数据转发到目的地的网络接口（网卡）。
- 如果 IP 协议要传输数据，就要将数据转换成为链路层的分组，然后才可以在链路层传输。
- MTU 指的是 Maximun Transmission Unit，最大传输单元，意思是链路层网络允许的最大传输数据分组的大小。因此 IP 协议要根据 MTU 拆分封包。
- NAT 技术转换的是 IP 地址，私有 IP 通过 NAT 转换为公网 IP 发送到服务器。服务器的响应，通过 NAT 转换为私有 IP，返回给客户端。通过这种方式，就解决了内网和外网的通信问题。
- NAT 需要作为一个中间层替换 IP 地址。发送的时候，NAT 替换源 IP 地址（也就是将内网 IP 替换为出口 IP）；接收的时候，NAT 替换目标 IP 地址（也就是将出口 IP 替换回内网 IP 地址）。
- NAT 需要缓存内网 IP 地址和出口 IP 地址 + 端口的对应关系。也就是说，发送的时候，NAT 要为每个替换的内网 IP 地址分配不同的端口，确保出口 IP 地址 + 端口的唯一性，这样当服务器返回数据的时候，就可以根据出口 IP 地址 + 端口找到内网 IP。

## ARP 地址解析协议

- 一个中间服务帮助根据 IP 地址找到 MAC 地址——这就是地址解析协议（Address Resolution Protocol，ARP）。
- 如果一个网络接口已经知道目标 IP 地址对应的 MAC 地址了，它会将数据直接发送给交换机，交换机将数据转发给目的地。
- 如果网络接口不知道目的地地址，地址解析协议就开始工作了。发送接口会发送一个广播查询给到交换机，交换机将查询转发给所有接口。
- 如果某个接口发现自己就是对方要查询的接口，则会将自己的 MAC 地址回传。接下来，会在交换机和发送接口的 ARP 表中，增加一个缓存条目。
- 实际采用的是逐级缓存的设计减少 ARP 请求。发送接口先查询本地的 ARP 表，如果本地没有数据，然后广播 ARP 查询。这个时候如果交换机中有数据，那么查询交换机的 ARP 表；如果交换机中没有数据，才去广播消息给其他接口。注意，ARP 表是一种缓存，也要考虑缓存的设计。通常缓存的设计要考虑缓存的失效时间、更新策略、数据结构等。
