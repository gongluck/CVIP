# 负载均衡

- [负载均衡](#负载均衡)
  - [负载均衡原理](#负载均衡原理)
  - [Nginx](#nginx)
  - [OpenResty](#openresty)

## 负载均衡原理

- 负载均衡通过将流量分发给新增的服务器，提升了系统的性能。
- 对负载均衡最基本的要求，就是吞吐量要远大于上游的应用服务器，否则扩展能力会极为有限。
- 通过[AKF](./akf.md#x轴)立方体X轴扩展系统时，负载均衡只需要能够透传协议，并选择负载最低的上游应用作为流量分发对象即可。
- 基于[AKF](./akf.md#y轴)Y轴扩展系统时，负载均衡必须根据功能来分发请求，也就是说必须解析完应用层协议，才能明白这是什么请求。
- 基于[AKF](./akf.md#z轴)Z轴扩展时，如果只是使用了网络报文中的源IP地址，那么三层、四层负载均衡都能胜任。然而如果需要帐号、访问对象等用户信息扩展系统，仍然只能使用七层负载均衡从请求中获得。
- 考虑到信息安全，跑在公网上的外部协议常基于TLS/SSL协议，而在效率优先的企业内网中，一般不会使用大幅降低性能的TLS协议，因此负载均衡需要拥有卸载或者装载TLS层的能力。

## Nginx

- Nginx的开放式架构允许第三方模块通过10多个钩子函数，在不同的生命周期中处理请求。
- Nginx还允许C模块自行解析nginx.conf配置文件。

## OpenResty

- OpenResty就通过2个C模块，将Lua代码用LuaJIT编译到Nginx中执行，并通过FFI技术将C函数暴露给Lua代码。这就是OpenResty允许Lua语言与C模块协同处理请求的原因。
- OpenResty默认加入了四层负载均衡和TLS协议处理功能，还新增了近20个第三方C模块，这造成编译出的Nginx体积大了5倍。
