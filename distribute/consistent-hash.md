# 一致性哈希

- [一致性哈希](#一致性哈希)
  - [哈希失效](#哈希失效)
  - [一致性哈希](#一致性哈希-1)

## 哈希失效

- 在主机硬件达到性能瓶颈后，有状态服务可以沿AKF立方体Z轴，基于哈希算法扩展为分布式系统。
- 最大的问题是在系统扩容或者缩容时，必须迁移改变了映射关系的数据。
- 取模哈希函数中基数的变化，往往会导致绝大部分映射关系改变，原映射关系全部失效，数据都得迁移到其他节点。

## 一致性哈希

- 一致性哈希算法是通过以下步骤来建立数据与主机节点间映射关系
  - 将关键字经由通用的哈希函数映射为32位整型哈希值。这些哈希值会形成1个环，最大的数字相当于0。
  - 设集群节点数为N，将哈希环由小至大分成N段，每个主机节点处理哈希值落在该段内的数据。
- 在生产环境中主机节点很可能是异构的，所以要给高规格的服务器节点赋予更高的权重。一致性哈希算法改变节点的权重非常简单，只需要给每个节点分配更大的弧长即可。
- 扩容、缩容时，虽然节点数发生了变化，但只要小幅度调整环上各节点的位置，就不会导致大量数据的迁移。
- 当哈希值分布不均匀时，数据分布也不会均衡。在哈希环与真实节点间，添加虚拟节点层，可以通过新的哈希函数，分散不均匀的数据。每个真实节点含有的虚拟节点数越多，数据分布便会越均衡，但同时也会消耗更多的内存与计算力。
