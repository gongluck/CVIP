# BPF

- [BPF](#bpf)
  - [BPF 特点](#bpf-特点)
  - [BPF 开发和执行](#bpf-开发和执行)
  - [BCC](#bcc)

## BPF 特点

- eBPF 程序并不像常规的线程那样，启动后就一直运行在那里，它需要事件触发后才会执行。这些事件包括系统调用、内核跟踪点、内核函数和用户态函数的调用退出、网络事件，等等。借助于强大的内核态插桩(kprobe)和用户态插桩(uprobe)，eBPF 程序几乎可以在内核和应用的任意位置进行插桩。
- 把编写的 eBPF 程序转换为 BPF 字节码，然后再通过 bpf 系统调用提交给内核执行。内核在接受 BPF 字节码之前，会首先通过验证器对字节码进行校验，只有校验通过的 BPF 字节码才会提交到即时编译器执行。
- BPF 程序可以利用 BPF 映射(map)进行存储，而用户程序通常也需要通过 BPF 映射同运行在内核中的 BPF 程序进行交互。

## BPF 开发和执行

- 使用 C 语言开发一个 eBPF 程序。
- 借助 LLVM 把 eBPF 程序编译成 BPF 字节码。
- 通过 bpf 系统调用，把 BPF 字节码提交给内核;。
- 内核验证并运行 BPF 字节码，并把相应的状态保存到 BPF 映射中。
- 用户程序通过 BPF 映射查询 BPF 字节码的运行状态。

## BCC

- BCC 是一个 BPF 编译器集合，包含了用于构建 BPF 程序的编程框架和库，并提供了大量可以直接使用的工具。
- BCC把 eBPF 执行过程通过内置框架抽象起来，并提供了 Python、C++ 等编程语言接口。可以直接通过 Python 语 言去跟 eBPF 的各种事件和数据进行交互。
